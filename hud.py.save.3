import tkinter as tk
from tkinter import messagebox, scrolledtext
from PIL import Image, ImageTk
import os, subprocess, random, math, sys, fcntl
from datetime import datetime
import time

# --- SINGLE INSTANCE SHIELD ---
try:
    lock_file = open('/tmp/sumner_hud.lock', 'w')
    fcntl.lockf(lock_file, fcntl.LOCK_EX | fcntl.LOCK_NB)
except:
    sys.exit(0)

class SumnerHUD:
    def __init__(self, root):
        self.root = root
        self.sw = self.root.winfo_screenwidth()
        self.sh = self.root.winfo_screenheight()
        self.root.attributes('-fullscreen', True, "-topmost", True)
        self.root.config(bg='black')

        # --- PATHS ---
        self.path_allsky = "/var/www/html/allsky/images/latest.jpg"
        self.path_radar = "/home/pi/allsky_guard/radar.png"
        self.path_clock = "/home/pi/allsky_guard/clock_sumner.png"
        self.path_sensors = "/home/pi/allsky_guard/sensors.txt"
        self.path_hours = "/home/pi/allsky_guard/hours.txt"
        self.path_notes = "/home/pi/allsky_guard/dossier.txt"
        self.path_mirror_cfg = "/home/pi/allsky_guard/mirror_config.txt"
        self.path_thresh = "/home/pi/allsky_guard/cloud_threshold.txt"
        self.path_radar_id = "/home/pi/allsky_guard/radar_coords.txt"
        self.path_sync_script = "/home/pi/allsky_guard/get_radar.py"
        
        self.app_manager = "/usr/share/applications/indigo-server-manager.desktop"
        self.app_imager = "/usr/share/applications/ain-imager.desktop"

        self.cloud_threshold = 30.0
        if os.path.exists(self.path_thresh):
            try:
                with open(self.path_thresh, "r") as f:
                    self.cloud_threshold = float(f.read().strip())
            except: pass

        self.canvas = tk.Canvas(root, width=self.sw, height=self.sh, bg='black', highlightthickness=0)
        self.canvas.pack()
        
        self.draw_stars()
        self.create_ui_elements()
        self.check_cleaning_reminder()
        self.update_loop()

    def load_scale(self, path, w, h):
        if not os.path.exists(path): return None
        try:
            # Open the image and force it to load immediately (avoids file-lock issues)
            with Image.open(path) as img:
                img = img.convert("RGB")
                img.thumbnail((w, h), Image.Resampling.LANCZOS)
                return ImageTk.PhotoImage(img)
        except: 
            return None

    def create_ui_elements(self):
        # Buttons and Controls
        tk.Button(self.root, text="MAINT / DOSSIER", command=self.open_dossier, bg="#222", fg="white", font=("Arial", 9, "bold")).place(x=20, y=20)
        tk.Button(self.root, text="EXIT HUD", command=self.root.destroy, bg="#500", fg="white", font=("Arial", 9, "bold")).place(x=150, y=20)

        # Right Side Sensor Box
        box_w, box_h = int(self.sw * 0.25), int(self.sh * 0.85)
        rx, ry = self.sw - box_w - 20, 40
        self.canvas.create_rectangle(rx, ry, rx + box_w, ry + box_h, fill='#050505', outline='#00FFCC', width=3)
        
        y_off, spacing = ry + 45, box_h // 12.5
        self.val_sky   = self.add_sensor_line("ðŸŒ¡ï¸", "SKY TEMP:", rx + 15, y_off, "#AAB7B8", box_w)
        self.val_cloud = self.add_sensor_line("â˜ï¸", "SKY COND:", rx + 15, y_off + spacing, "#5DADE2", box_w)
        
        # ... (rest of sensor lines and slider omitted for brevity but preserved in your real code) ...

        # Center Images
        self.all_img_id = self.canvas.create_image(self.sw*0.22, self.sh*0.4, anchor='center')
        self.rad_img_id = self.canvas.create_image(self.sw*0.53, self.sh*0.4, anchor='center')
        self.clk_img_id = self.canvas.create_image(self.sw*0.38, self.sh*0.82, anchor='center')

    def add_sensor_line(self, icon, label, x, y, color, box_w):
        f_size = 11 if self.sw > 1000 else 8
        self.canvas.create_text(x, y, text=icon, anchor='w', fill=color, font=("Arial", 16))
        self.canvas.create_text(x + 40, y, text=label, anchor='w', fill="white", font=("Arial", f_size, "bold"))
        return self.canvas.create_text(x + box_w - 30, y, text="--", anchor='e', fill="cyan", font=("Courier", 16, "bold"))

    def open_dossier(self):
        d_win = tk.Toplevel(self.root)
        d_win.geometry(f"{int(self.sw*0.45)}x{int(self.sh*0.8)}")
        d_win.config(bg="#050505")
        d_win.attributes("-topmost", True)
        
        # Radar Station Entry
        r_frame = tk.Frame(d_win, bg="#111")
        r_frame.pack(fill="x", padx=20, pady=10)
        tk.Label(r_frame, text="Radar Station ID:", bg="#111", fg="white").pack(side="left")
        radar_entry = tk.Entry(r_frame, bg="black", fg="orange", insertbackground="white")
        radar_entry.pack(side="left", padx=10, fill="x", expand=True)
        if os.path.exists(self.path_radar_id):
            with open(self.path_radar_id, "r") as f: radar_entry.insert(0, f.read().strip())

        def save_all():
            with open(self.path_radar_id, "w") as f: f.write(radar_entry.get().upper())
            d_win.destroy()
            # Immediately trigger a refresh of the images
            self.update_loop()

        def force_sync():
            subprocess.Popen(["python3", self.path_sync_script])
            messagebox.showinfo("SYNC", "Radar Sync Started...")

        btn_f = tk.Frame(d_win, bg="#050505")
        btn_f.pack(fill="x", side="bottom", pady=20)
        tk.Button(btn_f, text="ðŸ”„ FORCE SYNC", bg="#4B0082", fg="white", command=force_sync).pack(side="left", padx=20)
        tk.Button(btn_f, text="ðŸ’¾ SAVE", bg="#1E8449", fg="white", command=save_all).pack(side="right", padx=20)

    def update_loop(self):
        img_w, img_h = int(self.sw * 0.28), int(self.sh * 0.45)
        
        # Force a fresh load of the radar image
        new_rad = self.load_scale(self.path_radar, img_w, img_h)
        if new_rad:
            self.img_rad = new_rad
            self.canvas.itemconfig(self.rad_img_id, image=self.img_rad)

        # ... (rest of the update logic for sensors and allsky) ...
        self.root.after(5000, self.update_loop)

# (Rest of class and main runner preserved)
